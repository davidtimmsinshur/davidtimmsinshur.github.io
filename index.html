<!DOCTYPE html>
<html>

<head>
	<title>Google Calendar API Quickstart</title>
	<link rel="icon" href="https://inshur.com/wp-content/uploads/2018/01/cropped-INSHUR-app-icon-32x32.png"
		sizes="32x32" />

	<meta charset="utf-8" />
</head>

<body>
	<p>Google Calendar API Quickstart</p>

	<!--Add buttons to initiate auth sequence and sign out-->
	<button id="authorize_button" style="display: none;">Authorize</button>
	<button id="signout_button" style="display: none;">Sign Out</button>
	<button id="current_button" style="display: none;">This Week</button>
	<button id="next_button" style="display: none;">Next Week</button>

	<!-- <img src="jubilee-desk-plan.png" alt="Jubilee Office Plan" width="800"/> -->
	<pre id="content" style="white-space: pre-wrap;"></pre>
	<script src="https://apis.google.com/js/api.js"></script>

	<script type="text/javascript">
		// Client ID and API key from the Developer Console
		var CLIENT_ID = '462660603403-khj5nlahao22ed684s838h5a2k734uhf.apps.googleusercontent.com';
		var API_KEY = 'AIzaSyBLsf9t5D6yVlzNi-fKb3SMZ-ZmC9EgBuw';

		// Array of API discovery doc URLs for APIs used by the quickstart
		var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest", "https://content.googleapis.com/discovery/v1/apis/admin/directory_v1/rest"];

		// Authorization scopes required by the API; multiple scopes can be
		// included, separated by spaces.
		var SCOPES = "https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/admin.directory.resource.calendar.readonly";

		var authorizeButton = document.getElementById('authorize_button');
		var signoutButton = document.getElementById('signout_button');
		var currentButton = document.getElementById('current_button');

		/**
		 *  On load, called to load the auth2 library and API client library.
		 */
		function handleClientLoad() {
			gapi.load('client:auth2', initClient);
		}

		/**
		 *  Initializes the API client library and sets up sign-in state
		 *  listeners.
		 */
		function initClient() {
			gapi.client.init({
				apiKey: API_KEY,
				clientId: CLIENT_ID,
				discoveryDocs: DISCOVERY_DOCS,
				scope: SCOPES
			}).then(function () {
				// Listen for sign-in state changes.
				gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

				// Handle the initial sign-in state.
				updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
				authorizeButton.onclick = handleAuthClick;
				signoutButton.onclick = handleSignoutClick;
				currentButton.onclick = handleExecuteClick;
			}, function (error) {
				appendPre(JSON.stringify(error, null, 2));
			});
		}

		/**
		 *  Called when the signed in status changes, to update the UI
		 *  appropriately. After a sign-in, the API is called.
		 */
		function updateSigninStatus(isSignedIn) {
			if (isSignedIn) {
				authorizeButton.style.display = 'none';
				signoutButton.style.display = 'block';
				currentButton.style.display = 'block';

				//listUpcomingEvents();
			} else {
				authorizeButton.style.display = 'block';
				signoutButton.style.display = 'none';
				currentButton.style.display = 'none';
			}
		}

		/**
		 *  Sign in the user upon button click.
		 */
		function handleAuthClick(event) {
			gapi.auth2.getAuthInstance().signIn();
		}

		/**
		 *  Sign out the user upon button click.
		 */
		function handleSignoutClick(event) {
			gapi.auth2.getAuthInstance().signOut();
		}

		/**
		   *  Do something when clicking execute.
		   */
		function handleExecuteClick(event) {
			clearContent();
			renderDesks();
			//listDesks();
			//listUpcomingEvents();
		}

		/**
		 * Append a pre element to the body containing the given message
		 * as its text node. Used to display the results of the API call.
		 *
		 * @param {string} message Text to be placed in pre element.
		 */
		function appendPre(message) {
			var pre = document.getElementById('content');
			var textContent = document.createTextNode(message + '\n');
			pre.appendChild(textContent);
		}

		function clearContent() {
			var content = document.getElementById('content');
			content.textContent = ""
		}

		function startAndEndOfWeekAsISOString(date) { //'2020-09-02T00:00:00Z'
			var curr = date ? date : new Date();
			//by default sets first/last day of week to sunday/saturday so don't need to worry about time portion as events will be mon - fri only
			var first = curr.getDate() - curr.getDay(); // First day is the  day of the month - the day of the week
			var last = first + 6; // last day is the first day + 6
			firstDay = new Date(curr.setDate(first)).toISOString();
			lastDay = new Date(curr.setDate(curr.getDate() + 6)).toISOString();
			console.log("start of week", firstDay);
			console.log("end of week", lastDay);
			return [firstDay, lastDay];
		}

		function listDesks() {
			console.log("listDesks");
			return gapi.client.directory.resources.calendars.list({
				"customer": "my_customer",
				"orderBy": "resourceName",
				"query": "\"generatedResourceName\": \"(Desk)-Brighton, UK - Social Distance-2-Desk*\""
			}).then(function (response) {
				console.log("Response", response);
				var assets = response.result.items;

				return assets;
			});
		}

		
		function renderDesksWithEvents() {
			console.log("renderDesksWithEvents");

			// get desks
			let assets = [];
			assets = listDesks();
			assets.then(assets => {
				console.log("desks", assets);

				let deskEvents = [];

				if (assets.length > 0) {

					for (i = 0; i < assets.length; i++) {
						var asset = assets[i];

						var name = asset.resourceName;
						var email = asset.resourceEmail;

						// for each desk get events
						// 	add events promise to array
						deskEvents.push(listUpcomingEvents(name, email));
						//listUpcomingEvents(name, email);
					}

					// Promise.all array of events
					Promise.all(deskEvents).then(events => {
						console.log("deskEvents", events);

						// Render results
						for (i = 0; i < events.length; i++) {
							appendPre(assets[i].resourceName + ' (' + assets[i].resourceEmail + ')');
							console.log("event array", events[i]);
							if (events[i].length > 0) {
								for (j = 0; j < events[i].length; j++) {
									var when = events[i][j].start.dateTime;
									if (!when) {
										when = events[i][j].start.date;
									}
									appendPre(events[i][j].summary + ' (' + when + ')');
								}

							} else {
								appendPre('No desk bookings for this period.');
							}
							appendPre("");
						}
					});
				} else {
					appendPre('No desks found.');
				}
			});

			assets.catch(err => {
				console.Error("listDesks", "There was an error processing the desks. " + err)
			});
		}

		function renderDesks() {
			let assets = [];
			assets = listDesks();
			assets.then(assets => {
				console.log("desks", assets);

				if (assets.length > 0) {

					for (i = 0; i < assets.length; i++) {
						var asset = assets[i];

						var name = asset.resourceName;
						var email = asset.resourceEmail;

						appendPre(name + ' (' + email + ')');
					}

				} else {
					appendPre('No desks found.');
				}
			});
			assets.catch(err => {
				console.Error("listDesks", "There was an error processing the desks. " + err)
			});
		}

		function renderEvents() {
			let events = [];
			events = listUpcomingEvents();
			events.then(events => {
				console.log("events", events);

				if (events.length > 0) {
					for (i = 0; i < events.length; i++) {
						var event = events[i];
						var when = event.start.dateTime;
						if (!when) {
							when = event.start.date;
						}
						appendPre(event.summary + ' (' + when + ')');
					}
					appendPre("");

				} else {
					appendPre('No bookings found.');
				}
			});
			events.catch(err => {
				console.Error("listEvents", "There was an error processing the events. " + err)
			});
		}


		/**
		 * Print the summary and start datetime/date of the next ten events in
		 * the authorized user's calendar. If no events are found an
		 * appropriate message is printed.
		 */
		function listUpcomingEvents(calendarName, calendarId, minTime, maxTime) {
			console.log("listUpcomingEvents");
			var calendar = calendarId ? calendarId : "c_1882pspe8q81ei2oku0d5hmqs1hjg4gad5n76q3le8n66rrd@resource.calendar.google.com";
			//week = startAndEndOfWeekAsISOString('2020-09-23T00:00:00Z');
			week = startAndEndOfWeekAsISOString();
			return gapi.client.calendar.events.list({
				"calendarId": calendar,
				"orderBy": "startTime",
				"singleEvents": true,
				"timeMax": week[1],
				"timeMin": week[0]
			}).then(function (response) {
				console.log("Response", response);
				var events = response.result.items;

				return events;
			});
		}

	</script>

	<script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()"
		onreadystatechange="if (this.readyState === 'complete') this.onload()">
		</script>
</body>

</html>